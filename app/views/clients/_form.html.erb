<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-title-md2 font-bold text-black dark:text-white">
      <%= @client.new_record? ? "Novo Cliente" : "Editar Cliente" %>
    </h2>
  </div>

  <div class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
    <%= form_with(model: @client, local: true, class: "p-6.5") do |form| %>
    <div data-controller="mask">
      <% if @client.errors.any? %>
        <div class="mb-4 rounded-lg border-l-6 border-[#F87171] bg-[#F87171] bg-opacity-[15%] px-7 py-8 shadow-md dark:bg-[#1B1B24] dark:bg-opacity-30">
          <h5 class="mb-3 font-semibold text-[#B45454]">
            <%= pluralize(@client.errors.count, "erro") %> impediu que este cliente fosse salvo:
          </h5>
          <ul class="list-inside list-disc">
            <% @client.errors.full_messages.each do |message| %>
              <li class="text-[#CD5D5D]"><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Dados Principais -->
      <div class="mb-4.5">
        <h3 class="mb-4 text-xl font-semibold text-black dark:text-white border-b pb-2">
          Dados Principais
        </h3>
        <div class="flex flex-col gap-6 xl:flex-row">
          <div class="w-full xl:w-1/1">
            <%= form.label :nome, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :nome, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
          </div>

          <div class="w-full xl:w-1/3">
            <%= form.label :apelido, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :apelido, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
          </div>
        </div>
      </div>

      <!-- Documentos -->
      <div class="mb-4.5">
        <h3 class="mb-4 text-xl font-semibold text-black dark:text-white border-b pb-2">
          Documentos
        </h3>
        <div class="mb-4.5">
          <%= form.label :pessoa, class: "mb-2.5 block text-black dark:text-white" %>
          <%= form.select :pessoa, 
              options_for_select([['Física', 'F'], ['Jurídica', 'J']], @client.pessoa),
              { include_blank: 'Selecione o tipo de pessoa' },
              class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
        </div>

        <div class="flex flex-col gap-6 xl:flex-row">
          <div class="w-full xl:w-1/2">
            <%= form.label :cpf, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :cpf, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "cpf",
                  action: "input->mask#cpf"
                } %>
          </div>

          <div class="w-full xl:w-1/2">
            <%= form.label :rg, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :rg, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
          </div>
        </div>

        <div class="flex flex-col gap-6 xl:flex-row mt-4.5">
          <div class="w-full xl:w-1/2">
            <%= form.label :cnpj, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :cnpj, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "cnpj",
                  action: "input->mask#cnpj"
                } %>
          </div>

          <div class="w-full xl:w-1/2">
            <%= form.label :ie, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :ie, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
          </div>
        </div>
      </div>

      <!-- Endereço -->
      <div class="mb-4.5">
        <h3 class="mb-4 text-xl font-semibold text-black dark:text-white border-b pb-2">
          Endereço
        </h3>
        <div class="mb-4.5">
          <%= form.label :endereco, class: "mb-2.5 block text-black dark:text-white" %>
          <%= form.text_field :endereco, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
        </div>

        <div class="flex flex-col gap-6 xl:flex-row">
          <div class="w-full xl:w-1/2">
            <%= form.label :bairro, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :bairro, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
          </div>

          <div class="w-full xl:w-1/2">
            <%= form.label :cep, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :cep, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "cep",
                  action: "input->mask#cep"
                } %>
          </div>
        </div>

        <div class="flex flex-col gap-6 xl:flex-row mt-4.5">
          <div class="w-full xl:w-1/4">
            <%= form.label :uf, "Estado", class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.select :uf, 
                City.estados, 
                { prompt: "Selecione o Estado" }, 
                { 
                  class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary", 
                  id: "estado-select" 
                } 
            %>
          </div>

          <div class="w-full xl:w-1/2">
            <%= form.label :cidade, "Cidade", class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.select :cidade, 
                [], 
                { prompt: "Primeiro selecione o Estado" }, 
                { 
                  class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary", 
                  id: "cidade-select", 
                  disabled: true 
                } 
            %>
          </div>

          <div class="w-full xl:w-1/4">
            <%= form.label :ibge, "Código IBGE", class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :ibge, 
                { 
                  class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary", 
                  id: "ibge-input", 
                  readonly: true 
                } 
            %>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const estadoSelect = document.getElementById('estado-select');
            const cidadeSelect = document.getElementById('cidade-select');
            const IbgeInput = document.getElementById('ibge-input');

            // Função para carregar municípios do estado
            function carregarMunicipios(uf) {
              fetch(`/cities/ajax/municipios?uf=${uf}`)
                .then(response => response.json())
                .then(municipios => {
                  cidadeSelect.innerHTML = '<option value="">Selecione a Cidade</option>';
                  municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    cidadeSelect.appendChild(option);
                  });
                  cidadeSelect.disabled = false;

                  // Se estiver editando, seleciona a cidade atual
                  const cidadeAtual = '<%= @client.cidade %>';
                  if (cidadeAtual) {
                    cidadeSelect.value = cidadeAtual;
                    cidadeSelect.dispatchEvent(new Event('change'));
                  }
                })
                .catch(error => {
                  console.error('Erro ao carregar municípios:', error);
                  cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                });
            }

            // Se já tiver um estado selecionado (edição), carrega municípios
            const ufAtual = '<%= @client.uf %>';
            if (ufAtual) {
              estadoSelect.value = ufAtual;
              carregarMunicipios(ufAtual);
            }

            estadoSelect.addEventListener('change', function() {
              const selectedUf = this.value;
              
              if (selectedUf) {
                carregarMunicipios(selectedUf);
              } else {
                cidadeSelect.innerHTML = '<option value="">Primeiro selecione o Estado</option>';
                cidadeSelect.disabled = true;
              }
            });

            cidadeSelect.addEventListener('change', function() {
              const selectedUf = estadoSelect.value;
              const selectedCidade = this.value;
              
              if (selectedUf && selectedCidade) {
                fetch(`/cities/ajax/detalhes_municipio?uf=${selectedUf}&cidade=${selectedCidade}`)
                  .then(response => response.json())
                  .then(detalhes => {
                    if (detalhes && detalhes.codigo_ibge) {
                      IbgeInput.value = detalhes.codigo_ibge;
                    } else {
                      IbgeInput.value = 'Não encontrado';
                    }
                  })
                  .catch(error => {
                    console.error('Erro ao buscar detalhes do município:', error);
                    IbgeInput.value = 'Erro ao carregar';
                  });
              } else {
                IbgeInput.value = '';
              }
            });

            // Preenche o código IBGE se já existir na edição
            const IbgeAtual = '<%= @client.ibge %>';
            if (IbgeAtual) {
              IbgeInput.value = IbgeAtual;
            }
          });
        </script>

      </div>

      <!-- Contato -->
      <div class="mb-4.5">
        <h3 class="mb-4 text-xl font-semibold text-black dark:text-white border-b pb-2">
          Contato
        </h3>
        <div class="flex flex-col gap-6 xl:flex-row">
          <div class="w-full xl:w-1/3">
            <%= form.label :fone1, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :fone1, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "telefone",
                  action: "input->mask#telefone"
                } %>
          </div>

          <div class="w-full xl:w-1/3">
            <%= form.label :fone2, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :fone2, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "telefone",
                  action: "input->mask#telefone"
                } %>
          </div>

          <div class="w-full xl:w-1/3">
            <%= form.label :celular, class: "mb-2.5 block text-black dark:text-white" %>
            <%= form.text_field :celular, 
                class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",
                data: { 
                  mask_target: "telefone",
                  action: "input->mask#telefone"
                } %>
          </div>
        </div>

        <div class="mt-4.5">
          <%= form.label :email, class: "mb-2.5 block text-black dark:text-white" %>
          <%= form.email_field :email, class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
        </div>
      </div>

      <!-- Status -->
      <div class="mb-6">
        <h3 class="mb-4 text-xl font-semibold text-black dark:text-white border-b pb-2">
          Status
        </h3>
        <div>
          <%= form.label :status, class: "mb-2.5 block text-black dark:text-white" %>
          <%= form.select :status, 
              Client.statuses.keys.map { |s| [s.titleize, s] },
              {},
              class: "w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary" %>
        </div>
      </div>

      <!-- Botões -->
      <div class="flex gap-4 mt-6">
        <%= form.submit "Salvar", class: "inline-flex items-center justify-center rounded-md bg-primary py-4 px-10 text-center font-medium text-white hover:bg-opacity-90" %>
        <%= link_to "Cancelar", clients_path, class: "inline-flex items-center justify-center rounded-md border border-stroke py-4 px-10 text-center font-medium text-black hover:bg-opacity-90 dark:border-strokedark dark:text-white" %>
      </div>
    </div>
    <% end %>
  </div>
</div>
